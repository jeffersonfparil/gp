# library(testthat)
# source("R/load.R")
# source("R/metrics.R")
# source("R/models.R")

test_that("fn_ols", {
    set.seed(123)
    list_sim = fn_simulate_data(n_pop=3, verbose=TRUE)
    G = fn_load_genotype(fname_geno=list_sim$fname_geno_vcf)
    list_pheno = fn_load_phenotype(fname_pheno=list_sim$fname_pheno_tsv)
    list_merged = fn_merge_genotype_and_phenotype(G=G, list_pheno=list_pheno, verbose=TRUE)
    n = nrow(list_merged$G)
    vec_idx_training = sample(c(1:n), floor(n/2))
    vec_idx_validation = c(1:n)[!(c(1:n) %in% vec_idx_training)]
    list_ols = fn_ols(list_merged, vec_idx_training, vec_idx_validation, verbose=TRUE)
    expect_equal(list_ols$list_perf$corr < 0.5, TRUE)
    expect_equal(list_ols$list_perf$corr, cor(list_ols$df_y_validation$y_true, list_ols$df_y_validation$y_pred))
    expect_equal(nrow(list_ols$df_y_validation), length(vec_idx_validation))
    expect_equal(list_ols$n_non_zero, ncol(G))
})

test_that("fn_ridge", {
    set.seed(123)
    list_sim = fn_simulate_data(n_pop=3, verbose=TRUE)
    G = fn_load_genotype(fname_geno=list_sim$fname_geno_vcf)
    list_pheno = fn_load_phenotype(fname_pheno=list_sim$fname_pheno_tsv)
    list_merged = fn_merge_genotype_and_phenotype(G=G, list_pheno=list_pheno, verbose=TRUE)
    n = nrow(list_merged$G)
    vec_idx_training = sample(c(1:n), floor(n/2))
    vec_idx_validation = c(1:n)[!(c(1:n) %in% vec_idx_training)]
    list_ridge = fn_ridge(list_merged, vec_idx_training, vec_idx_validation, verbose=TRUE)
    expect_equal(list_ridge$list_perf$corr < 0.5, TRUE)
    expect_equal(list_ridge$list_perf$corr, cor(list_ridge$df_y_validation$y_true, list_ridge$df_y_validation$y_pred))
    expect_equal(nrow(list_ridge$df_y_validation), length(vec_idx_validation))
    expect_equal(sum(list_ridge$vec_effects != 0.0), 1+ncol(G))
    expect_equal(list_ridge$n_non_zero < ncol(G), TRUE)
})

test_that("fn_lasso", {
    set.seed(123)
    list_sim = fn_simulate_data(n_pop=3, verbose=TRUE)
    G = fn_load_genotype(fname_geno=list_sim$fname_geno_vcf)
    list_pheno = fn_load_phenotype(fname_pheno=list_sim$fname_pheno_tsv)
    list_merged = fn_merge_genotype_and_phenotype(G=G, list_pheno=list_pheno, verbose=TRUE)
    n = nrow(list_merged$G)
    vec_idx_training = sample(c(1:n), floor(n/2))
    vec_idx_validation = c(1:n)[!(c(1:n) %in% vec_idx_training)]
    list_lasso = fn_lasso(list_merged, vec_idx_training, vec_idx_validation, verbose=TRUE)
    expect_equal(list_lasso$list_perf$corr < 0.5, TRUE)
    expect_equal(list_lasso$list_perf$corr, cor(list_lasso$df_y_validation$y_true, list_lasso$df_y_validation$y_pred))
    expect_equal(nrow(list_lasso$df_y_validation), length(vec_idx_validation))
    expect_equal(sum(list_lasso$vec_effects != 0.0) < 1+ncol(G), TRUE)
    expect_equal(list_lasso$n_non_zero < ncol(G), TRUE)
})

test_that("fn_elastic_net", {
    set.seed(123)
    list_sim = fn_simulate_data(n_pop=3, verbose=TRUE)
    G = fn_load_genotype(fname_geno=list_sim$fname_geno_vcf)
    list_pheno = fn_load_phenotype(fname_pheno=list_sim$fname_pheno_tsv)
    list_merged = fn_merge_genotype_and_phenotype(G=G, list_pheno=list_pheno, verbose=TRUE)
    n = nrow(list_merged$G)
    vec_idx_training = sample(c(1:n), floor(n/2))
    vec_idx_validation = c(1:n)[!(c(1:n) %in% vec_idx_training)]
    list_elastic = fn_elastic_net(list_merged, vec_idx_training, vec_idx_validation, verbose=TRUE)
    expect_equal(list_elastic$list_perf$corr < 0.5, TRUE)
    expect_equal(list_elastic$list_perf$corr, cor(list_elastic$df_y_validation$y_true, list_elastic$df_y_validation$y_pred))
    expect_equal(nrow(list_elastic$df_y_validation), length(vec_idx_validation))
    expect_equal(sum(list_elastic$vec_effects != 0.0) < 1+ncol(G), TRUE)
    expect_equal(list_elastic$n_non_zero < ncol(G), TRUE)
})

test_that("fn_Bayes_A", {
    set.seed(123)
    list_sim = fn_simulate_data(n_pop=3, verbose=TRUE)
    G = fn_load_genotype(fname_geno=list_sim$fname_geno_vcf)
    list_pheno = fn_load_phenotype(fname_pheno=list_sim$fname_pheno_tsv)
    list_merged = fn_merge_genotype_and_phenotype(G=G, list_pheno=list_pheno, verbose=TRUE)
    n = nrow(list_merged$G)
    vec_idx_training = sample(c(1:n), floor(n/2))
    vec_idx_validation = c(1:n)[!(c(1:n) %in% vec_idx_training)]
    list_BayesA = fn_Bayes_A(list_merged, vec_idx_training, vec_idx_validation, verbose=TRUE)
    expect_equal(list_BayesA$list_perf$corr < 0.5, TRUE)
    expect_equal(list_BayesA$list_perf$corr, cor(list_BayesA$df_y_validation$y_true, list_BayesA$df_y_validation$y_pred))
    expect_equal(nrow(list_BayesA$df_y_validation), length(vec_idx_validation))
    expect_equal(sum(list_BayesA$vec_effects != 0.0) < 1+ncol(G), TRUE)
    expect_equal(list_BayesA$n_non_zero < ncol(G), TRUE)
})
